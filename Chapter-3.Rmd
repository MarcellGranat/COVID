# Logit-modell {#Chapter-4}

```{css, echo=FALSE}
p {
  text-align: justify;
}
```


```{r package, include=FALSE, warning=FALSE}
library(tidyverse)
library(pROC)
library(ggplot2)
library(gt)
library(car)
library(dplyr)
library(HH)
library(lmtest)
library(sandwich)
```


```{r data, include=FALSE, warning=FALSE, message = F}
#Adatok megtisztítása
raw <- vroom::vroom('latestdata.csv') 

raw %>% 
  dplyr::select(outcome, age, sex, country, chronic_disease_binary, latitude, longitude, date_confirmation) %>% 
  mutate(
    continent = countrycode::countrycode(country, origin = 'country.name', destination = 'continent'),
    date = lubridate::dmy(date_confirmation),
    age = ifelse(str_detect(age, '-'), as.numeric(gsub("([0-9]+).*$", "\\1", age)) + 5, age),
    age = as.numeric(age)
  ) %>% 
  mutate( # cleaning the depedent var
    outcome = case_when(
      outcome == 'death' ~ 'died',
      outcome == 'died' ~ 'died', 
      outcome == 'Death' ~ 'died',
      outcome == 'dead' ~ 'died',
      outcome == 'Dead' ~ 'died',
      outcome == 'Died' ~ 'died',
      outcome == 'Deceased' ~ 'died',
      outcome == 'discharge' ~ 'survived',
      outcome == 'discharged' ~ 'survived',
      outcome == 'Discharged' ~ 'survived',
      outcome == 'Discharged from hospital' ~ 'survived',
      outcome == 'recovered' ~ 'survived',
      outcome == 'released from quarantine' ~ 'survived',
      outcome == 'recovered' ~ 'survived',
      outcome == 'Recovered' ~ 'survived',
      outcome == 'Recovered' ~ 'survived',
      outcome == 'Recovered' ~ 'survived',
      T ~ 'NA'
    )
  ) %>% 
  filter(outcome != 'NA') %>% 
  mutate(
    died = outcome == 'died'
  ) %>% dplyr::select(-outcome, -date_confirmation) %>% 
  {dat <<- .; .}
dat <- na.omit(dat)
```

## Változók parciális hatása a halálozási valószínűségre
Egyesével regresszálva a változókat az alábbi grafikonokat kapjuk
```{r, warning=FALSE}
logit_age <- glm(died~age, data=dat, family = binomial(logit))
summary(logit_age)
```


## Logit modell kalibrálása az összes tisztított és korábban bemutatott változóra

### Outlierek és VIF mutató alapján
```{r, warning=FALSE}
#Országok szintjén magas VIF mutató látható
logit <- glm(died~., data=dat, family=binomial(logit))
summary(logit)
vif(logit)

#Outlierek leszűrése
dat <- dat[abs(rstudent(logit))<3, ]

#Országok kihagyásával mérséklődik a VIF mutató
logit2 <- glm(died~.-country -longitude -latitude, data=dat, family=binomial(logit))
summary(logit2)
vif(logit2)

#Amerikát összevonva Ázsiával a VIF mutatók lecsökkennek
dat <- na.omit(dat)
dat[dat$continent=="Americas", "continent"] <- "Asia"

logit3 <- glm(died~.-country -longitude -latitude, data=dat, 
             family=binomial(logit))
summary(logit3)
vif(logit3)

#Sajnos még nem lineáris a modellünk, a változókat át kell alakítani
resettest(logit3)
crPlots(logit3)

```

### Nemlinearitás vizsgálata a RESET-teszttel
```{r, warning=FALSE}
#Először a dátumot vesszük ki a magyarázóváltozók közül, mivel az értelmezése nehézkes,
#majd az életkor változóját alakítjuk át a linearitás eléréséhez
logit4 <- glm(died~.-country -date -latitude -longitude +I(1/(0.1+age)), 
              data=dat, family=binomial(logit))
summary(logit4)
vif(logit4)
resettest(logit4)
crPlots(logit4)
```

```{r}
logit5 <- glm(died~.-country -age +I(1/(0.1+age)) -date -latitude -longitude, data=dat, 
              family=binomial(logit))
summary(logit5)
vif(logit5)
resettest(logit5)

#Elhagyható a magyarázóváltozók közül szinte az összes
linearHypothesis(logit5, c("I(1/(0.1 + age))=0", "continentEurope=0", "continentAsia=0", "continentOceania=0"))

logit6 <- glm(died~.-country -continent -age -date -latitude -longitude, data=dat, 
              family=binomial(logit))
summary(logit6)
resettest(logit6)

#Az együtthatók jelentése
exp(coef(logit6))
```

### Előrejelzés a kiválasztott modellel
```{r, warning=FALSE}
deathval <- predict(logit6, dat, type="response")
dat$deathval <- deathval
dat$becsult <- ifelse(deathval>0.5, "TRUE", "FALSE")
xtabs(~died+becsult, data=dat)

#A modell 77%-ban helyes eredményt ad
sum(dat$died==dat$becsult)/nrow(dat)
```

Optimális cut-off érték kiválasztása
```{r, warning=FALSE}
ROCgorbe <- roc(dat$died~dat$deathval)
plot(ROCgorbe)
2*auc(ROCgorbe)-1

#Mivel csak 4 típusú kimenetel lehet a megmaradt változókból, 
#így a költségfüggvény is 5 értéket vesz fel
ytengely <- ROCgorbe$sensitivities
xtengely <- ROCgorbe$specificities
kuszob <- ROCgorbe$thresholds
seged <- data.frame(kuszob, xtengely, ytengely)
table(dat$died)
seged$koltseg <- 4046*(1-xtengely)+1302*(1-ytengely)

ggplot(seged, aes(x=kuszob, y=koltseg))+geom_point()+geom_smooth()+xlim(0,1)
```
A függvény alapján a 0.5 lesz az optimális küszöbérték

